name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

# 添加权限设置
permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: [1.18]
        # Define platforms to build for
        platform:
          - { os: ubuntu-latest,   goos: linux,   goarch: amd64 }
          - { os: windows-latest,  goos: windows, goarch: amd64 }
          - { os: macos-latest,    goos: darwin,  goarch: amd64 }
          - { os: macos-latest,    goos: darwin,  goarch: arm64 }
          - { os: ubuntu-latest,   goos: android, goarch: arm64 }
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ matrix.go-version }}
        
    - name: Install dependencies
      run: |
        go mod tidy
        
    - name: Run tests
      run: |
        go test -v ./...
        
    - name: Build binary
      run: |
        # Set environment variables for cross-compilation
        export GOOS=${{ matrix.platform.goos }}
        export GOARCH=${{ matrix.platform.goarch }}
        export CGO_ENABLED=0
        
        # Create output directory
        mkdir -p dist
        
        # Set binary name based on platform
        if [ "${{ matrix.platform.goos }}" = "windows" ]; then
          BINARY_NAME="encrypt-${{ matrix.platform.goos }}-${{ matrix.platform.goarch }}.exe"
        else
          BINARY_NAME="encrypt-${{ matrix.platform.goos }}-${{ matrix.platform.goarch }}"
        fi
        
        # Build the binary
        echo "Building ${BINARY_NAME} for ${{ matrix.platform.goos }}/${{ matrix.platform.goarch }}"
        go build -o "dist/${BINARY_NAME}" -ldflags "-s -w" encrypt.go help.go
        
        # Verify build succeeded
        if [ ! -f "dist/${BINARY_NAME}" ]; then
          echo "Build failed: dist/${BINARY_NAME} not found"
          exit 1
        fi
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: encrypt-${{ matrix.platform.goos }}-${{ matrix.platform.goarch }}
        path: dist/
        
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-assets
        
    - name: Organize release assets
      run: |
        # Create final release directory
        mkdir -p final-release
        
        # Move all binaries to final release directory
        find release-assets -name "encrypt-*" -type f -exec mv {} final-release/ \;
        
        # Copy config file and changelog to final release directory
        cp encrypt_config.yaml final-release/ || echo "No config file found"
        cp CHANGELOG.md final-release/ || echo "No CHANGELOG file found"
        
        # Create checksums
        cd final-release
        sha256sum * > checksums.txt
        cd ..
        
    - name: Get version
      id: get_version
      run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}
      
    - name: Get changelog
      id: get_changelog
      run: |
        VERSION=${{ steps.get_version.outputs.VERSION }}
        # Extract changelog for this version
        awk "/## \[${VERSION##v}\]/,/^## \[.*\]/" CHANGELOG.md | head -n -1 > RELEASE_NOTES.md || echo "No changelog found for this version"
        echo "::set-output name=changelog::$(cat RELEASE_NOTES.md | sed ':a;N;$!ba;s/\n/%0A/g')"
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        body: ${{ steps.get_changelog.outputs.changelog }}
        files: |
          final-release/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}